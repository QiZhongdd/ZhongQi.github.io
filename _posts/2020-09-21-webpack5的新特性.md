---
layout: post
title: webpack5çš„æ–°ç‰¹æ€§
subtitle: webpack5çš„æ–°ç‰¹æ€§
date: 2020-09-25
author: Qi
header-img: img/404-bg.jpg
catalog: true
tags:
  - webpack
---

# NodeJS çš„ polyfill è„šæœ¬è¢«ç§»é™¤

Webpack ç›®æ ‡æ˜¯å…è®¸åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ Node æ¨¡å—ã€‚ä½†æ˜¯ç°åœ¨åœ¨ Webpack çœ‹æ¥ï¼Œå¤§å¤šæ¨¡å—å°±æ˜¯ä¸“é—¨ä¸ºå‰ç«¯å¼€å‘çš„ã€‚åœ¨ v4 åŠä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå¯¹äºå¤§å¤šæ•°çš„ Node æ¨¡å—ä¼šè‡ªåŠ¨æ·»åŠ  polyfill è„šæœ¬ï¼Œpolyfill ä¼šåŠ åˆ°æœ€ç»ˆçš„ bundle ä¸­ï¼Œå…¶å®é€šå¸¸æƒ…å†µä¸‹æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚åœ¨ v5 ä¸­å°†åœæ­¢è¿™ä¸€è¡Œä¸º

```
//index.js
import sha256 from 'crypto-js/sha256';
 
const hashDigest = sha256('hello world');
console.log(hashDigest);

```
åœ¨ v4 ä¸­ï¼Œä¼šä¸»åŠ¨æ·»åŠ  crypto çš„ polyfillï¼Œä¹Ÿå°±æ˜¯ crypto-browserifyã€‚æˆ‘ä»¬è¿è¡Œçš„ä»£ç æ˜¯ä¸éœ€è¦çš„ï¼Œåè€Œæœ€åçš„åŒ…å˜å¤§ï¼Œç¼–è¯‘ç»“æœ 417 kbï¼š

![Image text](/img/WechatIMG285.png)

åœ¨ v5 ä¸­ï¼Œå¦‚æœé‡åˆ°äº†è¿™æ ·çš„æƒ…å†µï¼Œä¼šæç¤ºä½ è¿›è¡Œç¡®è®¤ã€‚å¦‚æœç¡®è®¤ä¸éœ€è¦ node polyfillï¼ŒæŒ‰ç…§æç¤º alias è®¾ç½®ä¸º false å³å¯ã€‚æœ€åçš„ç¼–è¯‘ç»“æœä»…æœ‰ 5.69 kbï¼š
```
resolve:{alias: { crypto: false }}

```

![Image text](/img/WechatIMG296.png)

# ä¼˜åŒ–é•¿æœŸç¼“å­˜

åœ¨V4ä¸­ï¼ŒåŸæ¥çš„ moduleIdå’Œchunkidé»˜è®¤å€¼æ˜¯è‡ªå¢ idï¼Œå½“æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ¯”å¦‚åˆ é™¤ç­‰å®¹æ˜“å¯¼è‡´æ–‡ä»¶ç¼“å­˜å¤±æ•ˆã€‚Webpack 5 é’ˆå¯¹ moduleId  å’Œ chunkId çš„è®¡ç®—æ–¹å¼è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¢åŠ ç¡®å®šæ€§çš„ moduleId å’Œ chunkId çš„ç”Ÿæˆç­–ç•¥ã€‚moduleId æ ¹æ®ä¸Šä¸‹æ–‡æ¨¡å—è·¯å¾„ï¼ŒchunkId æ ¹æ® chunk å†…å®¹è®¡ç®—ï¼Œæœ€åä¸º moduleId å’Œ chunkId ç”Ÿæˆ 3 - 4 ä½çš„æ•°å­— idï¼Œå®ç°é•¿æœŸç¼“å­˜ï¼Œç”Ÿäº§ç¯å¢ƒä¸‹é»˜è®¤å¼€å¯ã€‚

![Image text](/img/WechatIMG297.png)

# ä¼˜åŒ–ç¼–è¯‘é€Ÿåº¦
è‡ªå¸¦æŒä¹…åŒ–ç¼“å­˜

# TreeShakingä¼˜åŒ–

ç°åœ¨æœ‰è¿™æ ·ä¸€æ®µä»£ç ï¼š
```
// inner.js
export const a = 'aaaaaaaaaa';
export const b = 'bbbbbbbbbb';

// module.js
import * as inner from "./inner";
export { inner };

// index.js
import * as module from "./module";
console.log(module.inner.a);

```

åœ¨V4ç‰ˆæœ¬ä»¥ä¸Šä»£ç  aã€b å˜é‡æ˜¯è¢«å…¨éƒ¨æ‰“åŒ…çš„ï¼š
![Image text](/img/WechatIMG390.png)

ä½†æˆ‘ä»¬åªè°ƒç”¨äº† a å˜é‡ï¼Œç†æƒ³æƒ…å†µåº”è¯¥æ˜¯ b è¢«è¯†åˆ«ä¸º unusedï¼Œä¸è¢«æ‰“åŒ…ã€‚è¿™ä¸€ä¼˜åŒ–åœ¨ v5 ä¸­å®ç°äº†ã€‚ åœ¨ v5 ä¸­ä¼šåˆ†ææ¨¡å— export ä¸ import ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œæœ€ç»ˆçš„ä»£ç ç”Ÿæˆéå¸¸ç®€æ´ï¼šæœºåˆ¶è·Ÿrollupç±»å‹
![Image text](/img/WechatIMG381.png)


# minSize&maxSize æ›´å¥½çš„æ–¹å¼è¡¨è¾¾

åœ¨V4ç‰ˆæœ¬ä¸­é»˜è®¤æƒ…å†µä¸‹ï¼Œä»…èƒ½å¤„ç†javascriptçš„å¤§å°
![Image text](/img/WechatIMG2888.jpeg)
V5ç‰ˆæœ¬çš„å˜æ›´å¯ä»¥æ”¹å˜cssçš„å¤§å°
![Image text](/img/WechatIMG299.jpeg)

# Webpack5 Experiments

webpack 5ä¸­å¼•å…¥äº†experimentså¯é€‰é€‰é¡¹ï¼Œä»¥ä½¿ç”¨æˆ·èƒ½å¤Ÿæ¿€æ´»å’Œè¯•ç”¨å®éªŒåŠŸèƒ½

**topLevelAwait æ”¯æŒé¡¶çº§Await Stage**
åœ¨webpack5ä¹‹å‰ï¼Œasyncå’Œawaitå¿…é¡»åŒæ—¶ä½¿ç”¨ï¼Œåœ¨webpack5ä¸­èƒ½å¤Ÿå•ç‹¬ä½¿ç”¨awaitï¼Œå¹¶ä¸”è¿˜æ”¯æŒtopLevelAwait.

```
//webpack4
//demo/data.js
const data = 'äº¬ç¨‹ä¸€ç¯';
export default data;
//demo/index.js
let output;
async function main() {
  const dynamic = await import('./data');
  output = dynamic + 'ğŸ®';
}
main();
export { output };

//æ‰§è¡Œå¦‚ä¸‹ä»£ç 
import { output } from './demo';
console.log(output);
// å¾ˆé—æ†¾outputæ˜¯undefined
```
webpack5 èƒ½å¤Ÿå•ç‹¬ä½¿ç”¨await

```
//é‡å†™demo/index.js
const dynamic = await import('./data');
export const output = dynamic.default + 'ï£¿';
//ä½ ä¹Ÿå¯ä»¥è¿™ä¹ˆå†™
const dynamic = import('./data');
export const output = (await dynamic).default + Math.random() + 'ğŸŠ';



```

webpack5èƒ½å¤Ÿæ”¯æŒTopLevelAwait

```
const connectToDB = async () => {
  const data = await new Promise((r) => {
    r('äº¬ç¨‹ä¸€ç¯');
  });
  return data;
};
const result = await connectToDB();
let output = `${result}ğŸŠ`;
export { output };

//æ‰§è¡Œå¦‚ä¸‹ä»£ç 
import await { output } from './demo02';
console.log(output);

```
è°ƒæ•´ä¸€ä¸‹webpack.config.js

```
module.exports = {
  experiments: {
    importAsync: true,
    topLevelAwait: true,
    // æ”¯æŒimport await
    importAwait: true,
  },
};

```

**ä½¿ç”¨assestä»£æ›¿url-loaderã€raw-loaderã€file-loader**

```

 module: {
    rules: [
      {
        test: /\.(png|jpg|jpeg|gif|eot|woff|woff2|ttf|svg|otf)$/,
        type: 'asset',
      },
    ]
  },
 experiments: {
    asset: true,
 },

```

**ä½¿ç”¨WebAssembly**
webpack4åªèƒ½åœ¨å¼‚æ­¥æ¨¡å—å¯¼å…¥WebAssembly,å¦‚æœåŒæ­¥åŠ è½½é‚£ä¹ˆå°±ä¸èƒ½å½“åˆchunkï¼Œä¼šæŠ¥é”™ï¼Œè€Œwebpack5å¯ä»¥å®ç°åŒæ­¥åŠ è½½

```
//webpack4åªèƒ½è¿™æ ·å»åŠ è½½program.wasm
//å¦‚æœåŒæ­¥å»åŠ è½½ ä¼šæŠ¥é”™ä¸èƒ½æŠŠwasmå½“æˆä¸»chunk
import('./demo04/program.wasm').then((p) => {
  console.log(p.add(4, 6));
});
//webpack5éœ‡æ’¼æ¥è¢­ 
import { add } from './demo03/program';
console.log(add(4, 6));
```

ç»§ç»­ä¿®æ”¹webpack.config.js
```
module.exports = {
  experiments: {
    asyncWebAssembly: true,
    syncWebAssembly: true,
  },
};

```

**èƒ½å¤Ÿä½¿ç”¨mjs**

```
const data = 'äº¬ç¨‹ä¸€ç¯';
export default data;
//è¿è¡Œä¸€ä¸‹ä»£ç 
import data from './demo5';
console.log(data);

```

```
module.exports = {
  experiments: {
     mjs: true,
  },
};
```

**Module Federation**

è®© Webpack è¾¾åˆ°äº†çº¿ä¸Š runtime çš„æ•ˆæœï¼Œè®©ä»£ç ç›´æ¥åœ¨ç‹¬ç«‹åº”ç”¨é—´åˆ©ç”¨ CDN ç›´æ¥å…±äº«ï¼Œä¸å†éœ€è¦æœ¬åœ°å®‰è£… NPM åŒ…ã€æ„å»ºå†å‘å¸ƒäº†ï¼
æœ‰äº†è¯¥ç‰¹æ€§å°±å¯ä»¥å¤šä¸ªå•ç‹¬çš„æ„å»ºåº”èƒ½å¤Ÿæ„æˆä¸€ä¸ªåº”ç”¨ã€‚ è¿™äº›ç‹¬ç«‹çš„æ„å»ºä¸ç›¸äº’ä¾èµ–ï¼Œå› æ­¤å¯ä»¥å•ç‹¬å¼€å‘å’Œéƒ¨ç½²ã€‚ è¿™æ ·ä¹Ÿèƒ½å®ç°å¾®å‰ç«¯ã€‚
ä»å›¾ä¸­å¯ä»¥å¾—çŸ¥å°±æ˜¯å°†ä¸€ä¸ªåº”ç”¨çš„bundleèƒ½å¤Ÿè¢«å¦ä¸€ä¸ªåº”ç”¨å¼•ç”¨ã€‚åº”ç”¨å¯ä»¥æ¨¡å—åŒ–è¾“å‡ºï¼Œå°±æ˜¯è¯´å®ƒæœ¬èº«å¯ä»¥è‡ªæˆ‘æ¶ˆè´¹ï¼Œä¹Ÿå¯ä»¥åŠ¨æ€åˆ†å‘ runtime å­æ¨¡å—ç»™å…¶ä»–åº”ç”¨ã€‚

![Image text](/img/WechatIMG421.png)

app1å’Œapp2çš„å…¥å£æ–‡ä»¶
```
// app1 & app2: index.js
import App from "./App";
import React from "react";
import ReactDOM from "react-dom";

ReactDOM.render(<App />, document.getElementById("root"));

```

app2 ç”Ÿäº§äº† Button ç»„ä»¶ï¼š

```
// app2: Button.js
import React from "react";

const Button = () => <button>App 2 Button</button>;

export default Button;

```

app2.js

```
// app2: App.js
import LocalButton from "./Button";
import React from "react";

const App = () => (
  <div>
    <h1>Basic Host-Remote</h1>
    <h2>App 2</h2>
    <LocalButton />
  </div>
);

export default App;

```

app1 å¼•ç”¨ app2 çš„ Button ç»„ä»¶ï¼š

```
// app1: App.js
import React from "react";
const RemoteButton = React.lazy(() => import("app2/Button"));

const App = () => (
  <div>
    <h1>Basic Host-Remote</h1>
    <h2>App 1</h2>
    <React.Suspense fallback="Loading Button">
      <RemoteButton />
    </React.Suspense>
  </div>
);

export default App;

```

ç”Ÿäº§äº† Button ç»„ä»¶çš„ app2ï¼Œå…¶é…ç½®æ–‡ä»¶ï¼š

app2 ä¸­æŒ‡æ˜äº†éœ€è¦ä¾èµ– reactã€react-domï¼Œå¹¶æœŸæœ›æ¶ˆè´¹çš„åº”ç”¨æä¾›ã€‚å¦‚æœ app1 æ²¡æœ‰æä¾›ï¼Œæˆ–æ²¡æœ‰æä¾›æŒ‡å®šç‰ˆæœ¬ï¼Œéœ€è¦æŠŠsharedæ³¨é‡Š

```
plugins: [
    new ModuleFederationPlugin({
      name: "app2Lib",//åº”ç”¨åç§°
      library: { type: "var", name: "app2Lib" },
      filename: "app2-remote-entry.js",//ç”Ÿæˆçš„å…¥å£æ–‡ä»¶
      exposes: {
        Button: "./src/Button",//éœ€è¦å¯¼å‡ºçš„æ–‡ä»¶
      },
      shared: ["react", "react-dom"],//éœ€è¦ä¾èµ–çš„åº“
    })
  ],
```

app1 çš„é…ç½®æ–‡ä»¶ï¼š

```
  new ModuleFederationPlugin({
      name: "app1",
      library: { type: "var", name: "app1" },
      remotes: {
        app2: "app2Lib",//éœ€è¦ç”¨åˆ°çš„è¿œç¨‹æ–‡ä»¶
      },
      shared: ["react", "react-dom"],
    }),
```

åœ¨ app1 html ä¸­åŠ è½½ app2-remote-entry.jsï¼š

```
<html>
  <head>
    <script src="http://localhost:3002/app2-remote-entry.js"></script>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>

```


# å‚è€ƒ
https://mp.weixin.qq.com/s/aC8mZZ8cwwY-mwhU0TL0JQ
https://juejin.im/post/6844904169405415432












