---
layout: post
title: webpack5çš„æ–°ç‰¹æ€§
subtitle: webpack5çš„æ–°ç‰¹æ€§
date: 2020-09-25
author: Qi
header-img: img/404-bg.jpg
catalog: true
tags:
  - webpack
---

# NodeJS çš„ polyfill è„šæœ¬è¢«ç§»é™¤

Webpack ç›®æ ‡æ˜¯å…è®¸åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ Node æ¨¡å—ã€‚ä½†æ˜¯ç°åœ¨åœ¨ Webpack çœ‹æ¥ï¼Œå¤§å¤šæ¨¡å—å°±æ˜¯ä¸“é—¨ä¸ºå‰ç«¯å¼€å‘çš„ã€‚åœ¨ v4 åŠä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå¯¹äºå¤§å¤šæ•°çš„ Node æ¨¡å—ä¼šè‡ªåŠ¨æ·»åŠ  polyfill è„šæœ¬ï¼Œpolyfill ä¼šåŠ åˆ°æœ€ç»ˆçš„ bundle ä¸­ï¼Œå…¶å®é€šå¸¸æƒ…å†µä¸‹æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚åœ¨ v5 ä¸­å°†åœæ­¢è¿™ä¸€è¡Œä¸º

```
//index.js
import sha256 from 'crypto-js/sha256';
 
const hashDigest = sha256('hello world');
console.log(hashDigest);

```
åœ¨ v4 ä¸­ï¼Œä¼šä¸»åŠ¨æ·»åŠ  crypto çš„ polyfillï¼Œä¹Ÿå°±æ˜¯ crypto-browserifyã€‚æˆ‘ä»¬è¿è¡Œçš„ä»£ç æ˜¯ä¸éœ€è¦çš„ï¼Œåè€Œæœ€åçš„åŒ…å˜å¤§ï¼Œç¼–è¯‘ç»“æœ 417 kbï¼š

![Image text](/img/WechatIMG285.png)

åœ¨ v5 ä¸­ï¼Œå¦‚æœé‡åˆ°äº†è¿™æ ·çš„æƒ…å†µï¼Œä¼šæç¤ºä½ è¿›è¡Œç¡®è®¤ã€‚å¦‚æœç¡®è®¤ä¸éœ€è¦ node polyfillï¼ŒæŒ‰ç…§æç¤º alias è®¾ç½®ä¸º false å³å¯ã€‚æœ€åçš„ç¼–è¯‘ç»“æœä»…æœ‰ 5.69 kbï¼š
```
resolve:{alias: { crypto: false }}

```

![Image text](/img/WechatIMG296.png)

# ä¼˜åŒ–é•¿æœŸç¼“å­˜

åœ¨V4ä¸­ï¼ŒåŸæ¥çš„ moduleIdå’Œchunkidé»˜è®¤å€¼æ˜¯è‡ªå¢ idï¼Œå½“æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ¯”å¦‚åˆ é™¤ç­‰å®¹æ˜“å¯¼è‡´æ–‡ä»¶ç¼“å­˜å¤±æ•ˆã€‚Webpack 5 é’ˆå¯¹ moduleId  å’Œ chunkId çš„è®¡ç®—æ–¹å¼è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¢åŠ ç¡®å®šæ€§çš„ moduleId å’Œ chunkId çš„ç”Ÿæˆç­–ç•¥ã€‚moduleId æ ¹æ®ä¸Šä¸‹æ–‡æ¨¡å—è·¯å¾„ï¼ŒchunkId æ ¹æ® chunk å†…å®¹è®¡ç®—ï¼Œæœ€åä¸º moduleId å’Œ chunkId ç”Ÿæˆ 3 - 4 ä½çš„æ•°å­— idï¼Œå®ç°é•¿æœŸç¼“å­˜ï¼Œç”Ÿäº§ç¯å¢ƒä¸‹é»˜è®¤å¼€å¯ã€‚

![Image text](/img/WechatIMG297.png)

# ä¼˜åŒ–ç¼–è¯‘é€Ÿåº¦
webpack5å¯ä»¥é…ç½®cacheï¼Œç›¸å½“äºé›†æˆäº†cacahe-loaderå’Œhard-source-webpack-pluginï¼Œæé«˜ç¼–è¯‘é€Ÿåº¦

```
  cache:{
        type:'filesystem',//memoryè¡¨ç¤ºå†…å­˜ç¼“å­˜,filesystemè¡¨ç¤ºç¡¬ç›˜ç¼“å­˜
    },

```
# TreeShakingä¼˜åŒ–

ç°åœ¨æœ‰è¿™æ ·ä¸€æ®µä»£ç ï¼š
```
// inner.js
export const a = 'aaaaaaaaaa';
export const b = 'bbbbbbbbbb';

// module.js
import * as inner from "./inner";
export { inner };

// index.js
import * as module from "./module";
console.log(module.inner.a);

```

åœ¨V4ç‰ˆæœ¬ä»¥ä¸Šä»£ç  aã€b å˜é‡æ˜¯è¢«å…¨éƒ¨æ‰“åŒ…çš„ï¼š
![Image text](/img/WechatIMG390.png)

ä½†æˆ‘ä»¬åªè°ƒç”¨äº† a å˜é‡ï¼Œç†æƒ³æƒ…å†µåº”è¯¥æ˜¯ b è¢«è¯†åˆ«ä¸º unusedï¼Œä¸è¢«æ‰“åŒ…ã€‚è¿™ä¸€ä¼˜åŒ–åœ¨ v5 ä¸­å®ç°äº†ã€‚ åœ¨ v5 ä¸­ä¼šåˆ†ææ¨¡å— export ä¸ import ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œæœ€ç»ˆçš„ä»£ç ç”Ÿæˆéå¸¸ç®€æ´ï¼šæœºåˆ¶è·Ÿrollupç±»å‹
![Image text](/img/WechatIMG381.png)


# minSize&maxSize æ›´å¥½çš„æ–¹å¼è¡¨è¾¾

åœ¨V4ç‰ˆæœ¬ä¸­é»˜è®¤æƒ…å†µä¸‹ï¼Œä»…èƒ½å¤„ç†javascriptçš„å¤§å°
![Image text](/img/WechatIMG2888.jpeg)
V5ç‰ˆæœ¬çš„å˜æ›´å¯ä»¥æ”¹å˜cssçš„å¤§å°
![Image text](/img/WechatIMG299.jpeg)

# Webpack5 Experiments

webpack 5ä¸­å¼•å…¥äº†experimentså¯é€‰é€‰é¡¹ï¼Œä»¥ä½¿ç”¨æˆ·èƒ½å¤Ÿæ¿€æ´»å’Œè¯•ç”¨å®éªŒåŠŸèƒ½

**topLevelAwait æ”¯æŒé¡¶çº§Await Stage**
åœ¨webpack5ä¹‹å‰ï¼Œasyncå’Œawaitå¿…é¡»åŒæ—¶ä½¿ç”¨ï¼Œåœ¨webpack5ä¸­èƒ½å¤Ÿå•ç‹¬ä½¿ç”¨awaitï¼Œå¹¶ä¸”è¿˜æ”¯æŒtopLevelAwait.

```
//webpack4
//demo/data.js
const data = 'äº¬ç¨‹ä¸€ç¯';
export default data;
//demo/index.js
let output;
async function main() {
  const dynamic = await import('./data');
  output = dynamic + 'ğŸ®';
}
main();
export { output };

//æ‰§è¡Œå¦‚ä¸‹ä»£ç 
import { output } from './demo';
console.log(output);
// å¾ˆé—æ†¾outputæ˜¯undefined
```
webpack5 èƒ½å¤Ÿå•ç‹¬ä½¿ç”¨await

```
//é‡å†™demo/index.js
const dynamic = await import('./data');
export const output = dynamic.default + 'ï£¿';
//ä½ ä¹Ÿå¯ä»¥è¿™ä¹ˆå†™
const dynamic = import('./data');
export const output = (await dynamic).default + Math.random() + 'ğŸŠ';



```

webpack5èƒ½å¤Ÿæ”¯æŒTopLevelAwait

```
const connectToDB = async () => {
  const data = await new Promise((r) => {
    r('äº¬ç¨‹ä¸€ç¯');
  });
  return data;
};
const result = await connectToDB();
let output = `${result}ğŸŠ`;
export { output };

//æ‰§è¡Œå¦‚ä¸‹ä»£ç 
import await { output } from './demo02';
console.log(output);

```
è°ƒæ•´ä¸€ä¸‹webpack.config.js

```
module.exports = {
  experiments: {
    importAsync: true,
    topLevelAwait: true,
    // æ”¯æŒimport await
    importAwait: true,
  },
};

```

**ä½¿ç”¨assestä»£æ›¿url-loaderã€raw-loaderã€file-loader**

```

 module: {
    rules: [
      {
        test: /\.(png|jpg|jpeg|gif|eot|woff|woff2|ttf|svg|otf)$/,
        type: 'asset',
      },
    ]
  },
 experiments: {
    asset: true,
 },

```

**ä½¿ç”¨WebAssembly**
webpack4åªèƒ½åœ¨å¼‚æ­¥æ¨¡å—å¯¼å…¥WebAssembly,å¦‚æœåŒæ­¥åŠ è½½é‚£ä¹ˆå°±ä¸èƒ½å½“åˆchunkï¼Œä¼šæŠ¥é”™ï¼Œè€Œwebpack5å¯ä»¥å®ç°åŒæ­¥åŠ è½½

```
//webpack4åªèƒ½è¿™æ ·å»åŠ è½½program.wasm
//å¦‚æœåŒæ­¥å»åŠ è½½ ä¼šæŠ¥é”™ä¸èƒ½æŠŠwasmå½“æˆä¸»chunk
import('./demo04/program.wasm').then((p) => {
  console.log(p.add(4, 6));
});
//webpack5éœ‡æ’¼æ¥è¢­ 
import { add } from './demo03/program';
console.log(add(4, 6));
```

ç»§ç»­ä¿®æ”¹webpack.config.js
```
module.exports = {
  experiments: {
    asyncWebAssembly: true,
    syncWebAssembly: true,
  },
};

```

**èƒ½å¤Ÿä½¿ç”¨mjs**

```
const data = 'äº¬ç¨‹ä¸€ç¯';
export default data;
//è¿è¡Œä¸€ä¸‹ä»£ç 
import data from './demo5';
console.log(data);

```

```
module.exports = {
  experiments: {
     mjs: true,
  },
};
```

# å‚è€ƒ
https://mp.weixin.qq.com/s/aC8mZZ8cwwY-mwhU0TL0JQ
https://juejin.im/post/6844904169405415432












