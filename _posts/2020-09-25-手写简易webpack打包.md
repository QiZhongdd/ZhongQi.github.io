---
layout: post
title:  æ‰‹å†™ç®€æ˜“webpackæ‰“åŒ…
subtitle: æ‰‹å†™ç®€æ˜“webpackæ‰“åŒ…
date: 2020-09-25
author: Qi
header-img: img/404-bg.jpg
catalog: true
tags:
  - webpack
---


# æ€»ç»“
æ ¹æ®webpackçš„è¿è¡Œæµç¨‹ï¼Œwebpackçš„å®ç°æ­¥éª¤ç”±ä¸‹
- è¯»å–é…ç½®ï¼Œè¿è¡Œcompile.runå¼€å§‹ç¼–è¯‘
- è°ƒç”¨webpackçš„æ ¸å¿ƒåº“compiliation.buildModulè¿›è¡Œè§£æå’Œæ”¶é›†ç›¸å…³çš„ä¾èµ–ï¼ŒbuildModuleçš„å®ç°æ­¥éª¤å¦‚ä¸‹
- - è°ƒç”¨babylonæˆ–è€…babel-prestenvå¯¹æ–‡ä»¶è¿›è¡Œastè§£æï¼Œ
- - è·å–astè§£æåçš„ä»£ç åï¼Œè°ƒç”¨babel-transferæ ¹æ®importDirectionæ ‡è¯†æ”¶é›†ç›¸å…³æ¨¡å—çš„ä¾èµ–ï¼Œ
- - è¿ç”¨babel-coreå°†ä»£ç è¿›è¡Œç¼–è¯‘
- æ¨¡å—å’Œä¾èµ–æ„å»ºå®Œæˆåï¼Œè°ƒç”¨emitFiles,è·å–å‡ºå£æ–‡ä»¶è·¯å¾„ï¼Œè·å–æ¨¡æ¿æ–‡ä»¶å¹¶ç»“åˆç¼–è¯‘ä»£ç ç”Ÿæˆè¾“å‡ºä»£ç ï¼Œæ‰“åŒ…åˆ°distæ–‡ä»¶å¤¹ä¸­

![Image text](/img/WechatIMG388.png)

**è¯»å–é…ç½®è°ƒç”¨compiler.run**

```
//zqpack/index.js
const Compiler = require('./Compiler');
const option=require('./zqpack.config')
const compiler=new Compiler(option)
compiler.run()

```

**æ„å»ºcompiler**
- å®ä¾‹åŒ–compiliation
- è°ƒç”¨compiliation.buildModuleæ”¶é›†ä¾èµ–å’Œè§£æ

```
//zqpack/Compiler.js

const Compilation = require('./Compiliation');
class Compiler{
    constructor(options){
        this.options=options
        this.modules=[]
    }
    run(){
        const onCompiled = (err, compilation) => {};
        this.compile(onCompiled)
    }
    compile(callback){
        const compilation = this.newCompilation();
        //å¾—åˆ°ç¼–è¯‘åçš„å…¥å£æ–‡ä»¶ï¼Œ
        const entryMoudle=compilation.buildModule(this.options.entry, true)
        this.modules.push(entryMoudle);
        //è¿›è¡Œè§£æï¼Œå¾—åˆ°babelè§£æåçš„ä»£ç 
        this.modules.map((_module)=>{
            _module.dependencies.map((dependency) => {
                //moduleä¸­å¯èƒ½è¿˜æœ‰å…¶ä»–ä¾èµ–ï¼Œæ‰€ä»¥è¿›è¡Œé€’å½’
                this.modules.push(compilation.buildModule(dependency, false))
            })
        })
        //å°†ä»£ç æ ¹æ®æ¨¡æ¿ç”Ÿæˆåˆ°dist
        compilation.emitFiles();
    }
    createCompilation() {
        return new Compilation(this);
    }
    newCompilation() {
        const compilation = this.createCompilation();
        return compilation;
    }
}
module.exports=Compiler

```


**æ„å»ºcompiliation**

- buildModule
- - è¿›è¡Œastè§£æ
- - æ ¹æ®astï¼Œè·å–ç›¸å…³çš„ä¾èµ–å’Œbabelåçš„ä»£ç 

- emitFiles
- - è¯»å–è¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„
- - è·å–æœ«ç­æ–‡ä»¶
- - å°†babelç”Ÿæˆçš„ä»£ç æ’å…¥åˆ°æ¨¡æ¿ä¸­
- - å°†æ¨¡æ¿ä¸­çš„è¾“å‡ºåˆ°å¯¹åº”çš„æ–‡ä»¶ä¸­
```
const {join} =require('path')
const { writeFileSync } = require('fs');
const Parser=require('./Parser')
class Compiliation{
   constructor({options,modules}){
    this.modules=modules;
    this.options=options;
   } 
   //å¯¹ç›¸å…³æ¨¡å—è¿›è¡Œastè§£æ,åŒæ—¶å¤„ç†å„ä¸ªæ¨¡å—ä¹‹é—´çš„ä¾èµ–
   buildModule(fileName, isEntry) {
    let ast='';
    let absoutPath='';
    if(!isEntry){
        absoutPath = join(process.cwd(), './src/', fileName);
        ast = Parser.ast(absoutPath);
    }else{
        ast = Parser.ast(fileName);
    }
    //æ”¶é›†ä¾èµ–
    const dependencies=Parser.getDependency(ast);
    //è·å–babelç¼–è¯‘åçš„ä»£ç 
    const transformCode = Parser.transform(ast);
    return {
        fileName,
        dependencies,
        transformCode
    }
   }
   emitFiles() {
    let _modules = '';
       const outputPath = join(
        this.options.output.path,
        this.options.output.filename
      );
      this.modules.map((_module)=>{
        _modules += ` '${_module.fileName}': function (module, exports, require) {
            ${_module.transformCode}
          },`;
      })

      const template = `(function (modules) {
        var installedModules = {};
        function __webpack_require__(moduleId) {
          // Check if module is in cache
          if (installedModules[moduleId]) {
            return installedModules[moduleId].exports;
          }
          // module.exports = {};
          //æ„å»ºä¸€ä¸ªæ–°çš„æ¨¡å—åŒ–è§„èŒƒ å¹¶ å°†moduleIdæ”¾å…¥ç¼“å­˜
          var module = (installedModules[moduleId] = {
            exports: {},
          });
          modules[moduleId].call(
            module.exports,
            module,
            module.exports,
            __webpack_require__
          );
          //å°å¿ƒæœº
          return module.exports;
        }
        return __webpack_require__('${this.options.entry}');
      })({
       ${_modules}
      });
      `;
  writeFileSync(outputPath, template, 'utf-8');
   }
}
module.exports=Compiliation;

```

**parser**
- babylonç”¨æ¥astè§£æ
- traverseæ ¹æ®astä¸­çš„èŠ‚ç‚¹æ ‡è¯†è·å–ç›¸å…³çš„ä¾èµ–
- transformFromAstæ ¹æ®astç¼–è¯‘ä»£ç 

```
const fs=require('fs')
const babylon = require('babylon');
const traverse = require('babel-traverse').default;
const { transformFromAst } = require('@babel/core');
class Parser{
    static ast(path){
        const content=fs.readFileSync(path,'utf-8')
        return babylon.parse(content,{
            sourceType:'module'
        })
    }
    static getDependency(ast){
        const dependencies=[]
        //ä»astä¸­è¯»å–ImportDeclarationç±»å‹ï¼Œå³ç›¸å…³çš„ä¾èµ–
        //@babel/traverseä¸»è¦æ˜¯è§£ææ›´æ–°èŠ‚ç‚¹
        traverse(ast, {
            ImportDeclaration: ({ node }) => {
                dependencies.push(node.source.value);
            },
        })
        return dependencies
    }
    //å°†astçš„ä»£ç ç”¨babelè¿›è¡Œç¼–è¯‘
    static transform(ast) {
        const { code } = transformFromAst(ast, null, {
          presets: ['@babel/preset-env'],
        });
        return code;
    }
}
module.exports=Parser;

```

# ç¼–å†™plugin
pluginæ˜¯è¿è¡Œåˆ°æŸä¸ªæ—¶é—´èŠ‚ç‚¹çš„æ—¶å€™æ‰è§¦å‘ç›¸å…³çš„æ’ä»¶ï¼Œ"æ—¶é—´èŠ‚ç‚¹çš„è§¦å‘ä¸»è¦æ˜¯ç”±tapableå®ç°"ï¼Œtapableå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªeventEmitter

- åœ¨index.jså¯¹pluginè¿›è¡Œæ³¨å†Œ

```
const compiler = new Compiler(options)
for (const plugin of plugins) {
    plugin.apply(compiler)
}

```

- ç¼–å†™plugin

```
const pluginName = 'ConsoleLogOnBuildWebpackPlugin';

class ConsoleLogOnBuildWebpackPlugin {
    apply(compiler) {
        //å°†æ’ä»¶åœ¨compilerä¸­çš„hookè§¦å‘,compilationæ˜¯new Synhookä¼ è¿‡æ¥compilationå¯¹è±¡
        compiler.hooks.run.tap(pluginName, (compilation) => {
            console.log(' ğŸ”¥ğŸ”¥ğŸ”¥ webpack æ„å»ºè¿‡ç¨‹å¼€å§‹ï¼');
        });
    }
}
module.exports = ConsoleLogOnBuildWebpackPlugin;


```

- åœ¨compilerä¸­è§¦å‘å¯¹åº”çš„æ’ä»¶

```
//Compiler.js
constructor(options) {
    //æ³¨å†Œå¯¹åº”çš„hook
        this.hooks = {
            //åŒæ­¥äº‹ä»¶
            run: new SyncHook(['compilation']),
        };
    }
     compile() {
         //è§¦å‘
        this.hooks.run.call(compilation);
    }
```

