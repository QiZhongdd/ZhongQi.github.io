# 背景

目前在代码扫描平台上添加新的规则和配置规则集的流程都较为繁琐，存在很多人工和手动配置的步骤。随着有代码质量管理诉求的用户越来越多，现有的接入和配置方式不能满足用户对时效的需要。
因此需要通过代码质量平台帮助用户正确、高效的完成代码库扫描方案的配置和接入，并且支持按照用户配置的规则集合执行代码扫描。

# 项目的规划和目标

![Image text](/img/cea4701d6307e9d7c996ec2d55466274.png)

**提供基础的能力**

- 支持的环境
- - 服务端：Golang、PHP、Java、C/C++、Python
- - APP： Android、iOS
- - 前端：js、html、CSS
- 能够定位的问题
- - 代码风格
各种语言的代码规范。如：PEP8、阿里 Java 规范、Google C++ 规范 等等
自定义代码规范。如：实践规范、业务规范
代码坏味道。如：《重构》中的各种不正确做法，重复代码等等
代码复杂度
代码行数。如：函数内代码行数、单文件代码行数
复杂度
- 代码逻辑
空指针
非法内存访问。如：数组越界、使用未初始化变量
资源泄漏：如：链接未关闭、内存溢出等
并发错误。如：使用了非线程安全的数据结构
低效代码。如：非必要的循环
未使用代码
- 安全问题
有漏洞的依赖
敏感信息。如：敏感词、账户信息等
安全漏洞。如：SQL 注入等
合规问题
不合法权限调用
自定义
关键词扫描。
  
**数据驱动**

以数据驱动方式提升系统有效性， 以数据驱动方式提升代码质量。通过数据来反馈系统的‘作用’,扫描次数、扫描时长、发现的问题个数、发现的问题修复时长、误报率、漏报率、规则的有效性等等

**能力的输出**

- 集成内部的平台如mas、ide、oe、鲲鹏
- 开发api，让用户自己开发规则
- 建立官方代码质量标准，为各团队推荐好的质量规则、标准
- 各维度评估各代码库/组织的代码质量，提供代码质量管理工具。为整体代码质量提升提供方向、为运营提供数据支撑(如：代码健康管理：代码健康分、代码质量趋势、质量数据下钻分析)

# 整体架构以及扫描流程

![Image text](/img/clipboard_image_1644136718940.png)

- scan-manager

提供以下功能：

- - 规则、规则集和查看和配置
- - 每个规则集对应一到多个规则
- - 规则集编辑权限控制
- - 代码库扫描策略配置
- - 每个代码库对应一个扫描策略，扫描策略包括增量/全量扫描，忽略/过滤的文件
- - 触发代码扫描
- - 在页面上选择规则、忽略文件等选项执行快速扫描
- - 查看扫描历史记录，问题报告
- - 查看代码库的历史扫描记录，查看单次扫描报告

- scan-engine

- - 规则集解析：接收扫描任务，解析规则集将任务拆分为一到多个子任务，每个子任务包括某一lint工具及对应的扫描命令或配置文件。
- - 任务执行：启动容器，组织命令执行扫描，将扫描执行的结果通过http请求的方式发送给scan-engine服务。
- - 扫描任务状态管理：根据容器中回调scan-engine的结果，更新扫描各子任务状态。
- - 结果过滤：将所有的lint问题进行过滤处理，包括增量、忽略等配置。
增量：根据两次commit的diff 或 blame信息，筛选出仅在这次的commit中新增的问题。
忽略：忽略指定目录下的问题



![Image text](/img/clipboard_image_1644137480955.png)


# Eslint的原理以及如何手写一个rules

**解析成Ast**

默认使用 Espree 解析器将代码解析为 AST 抽象语法树，然后再对代码进行检查。可以使用https://astexplorer.net/查看ast语法树。

**编写规则**
- - meta（对象）包含规则的元数据
- - create ( function ) 返回一个对象，其中包含了 ESLint 在遍历 JavaScript 代码的抽象语法树 AST ( ESTree 定义的 AST ) 时，用来访问节点的方法
- - context.report ( ) 用来发布警告或错误，并能提供自动修复功能（取决于你所使用的配置）

```
module.exports = {
 meta: {
        type: "suggestion",
        docs: {
            description: "disallow unnecessary semicolons",
            category: "Possible Errors",
            recommended: true,
            url: "https://eslint.org/docs/rules/no-extra-semi"
        },
        fixable: "code",
        schema: [] // no options
  },
  create: function (context) {
    return {
      FunctionDeclaration: (node) => {
        if (node.params.length > 3) {
          context.report({
            node,
            message: "参数最多不能超过3个",
          });
        }
      },
    };
  },
};

```

**使用自定义规则**
  







