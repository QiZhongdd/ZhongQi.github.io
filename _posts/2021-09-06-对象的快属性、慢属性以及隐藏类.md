---
layout: post
title: 对象的快属性、慢属性以及隐藏类
subtitle: 对象的快属性、慢属性以及隐藏类
date: 2021-07-29
author: Qi
header-img: img/404-bg.jpg
catalog: true
tags:
  - v8
---

# 简介

了解对象的快属性、慢属性、隐藏类能了解对象属性的存储方式以及如何查找属性。通过了解这些可以知道对对象相关的操作怎么提高性能，规避消耗性能的操作

**常规属性和排序属性**

在了解快属性和慢属性之前先说明常规属性和排序属性。

- 排序属性（element）用来存储以数字为 key 的属性，数字属性会按照属性大小进行排列

- 在 v8 中数字属性以外的称谓常规属性（properties）

**快属性和慢属性**

将不同的属性保存在常规属性和排序属性中，简化了程序的复杂度，但查找的时候多了一步操作，得通过 properties 和 elemnt 去查找。为了提高查找效率，v8 将部分常规属性直接存储到对象本省，称为对象内属性，对象内属性的默认存储数量是 10 个。对 properties 属性超过 10 个时，会将超过 10 个以上的属性存储在一个字典中，通过 properties 指向去查找。

以线性存储的属性为快属性，存放在字典中的称为慢属性

![Image text](/img/e8ce990dce53295a414ce79e38149917.webp)

**总结**
v8 为了提高查找销量，将属性分别保存在 properties 和 elements 中，elements 指向 elements 对象，elements 对象安装大小存放排序属性。在 properties 对象中，会按照创建时的顺序保存常规属性，为了进一步提高查找效率，当 properties 中的属性少于一定数量时（默认是 10 个）会存放在对象自身中这进一步提高了查找销量，当属性较多时，或者反复进行添加和删除时，那么 V8 就会将线性的存储模式降级为非线性的字典存储模式，这样虽然降低了查找速度，但是却提升了修改对象的属性的速度。

# 隐藏类，在内存中查找对象属性

v8 为了提高在内存中通过隐藏类去查找对象的属性在内存中的位置。隐藏类借鉴了部分静态语言的特性，静态语言的查找速度是高于动态语言的（js 是静态语言），这是因为静态语言在声明对象之前要确定对象的结构，称为形状，形状一旦确定就不会在改变。这样静态语言就可以直接通过偏移量查询来查询对象的属性值，这也就是静态语言的执行效率高的一个原因。

v8 为了将静态类型的特性引入，会做出两个假设，对象创建好了不会添加和删除新的属性，符合这两个假设之后，V8 就可以对 JavaScript 中的对象做深度优化了。具体的做法就是为每一个对象创建一个隐藏类（map），map 包含对象的属性以及偏移量。

```
let point = {x:100,y:200}

```

![Image text](/img/51f5034a7f80e4e5684d5a301178c2f8.webp)

**多个对象共用一个隐藏类**

V8 中，每个对象都有一个 map 属性，如果多个对象有相同的属性并且属性的排序相同，那么会共用一个 map 对象，这样可以减少 map 对象的创建次数，间接提高了执行速度，同时减少了存储空间。

```

let point = {x:100,y:200};
let point2 = {x:3,y:4};
%DebugPrint(point);
%DebugPrint(point2);

```

![Image text](/img/9f0de55e75463406fbbff452dcef2178.webp)

**重新构建隐藏类**

实现隐藏类的条件是创建的对象属性不再添加和修改，所以一旦对象的属性删除和添加就得重新构建隐藏类，这对于 V8 的执行效率来说，是一笔大的开销。**那么在实际工作中，我们应该尽量注意以下几点：**

- 使用字面量初始化对象时，要保证属性的顺序是一致的
- 尽量使用字面量一次性初始化完整对象属性。
- 尽量避免使用 delete 方法。

# 有了隐藏类，为什么还需要有快慢属性

应该说快属性，是建立在隐藏类基础上的，对象查找属性，先通过名字，在隐藏类中找到偏移量，然后在线性结构 properties 中拿到值！但是在键值过多时，properties 变成字典结构，这时就没有隐藏类偏移量一说，会从字典结构比较慢的查找
