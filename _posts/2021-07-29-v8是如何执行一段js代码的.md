---
layout: post
title: v8是如何执行一段js代码的
subtitle: v8是如何执行一段js代码的
date: 2021-07-29
author: Qi
header-img: img/404-bg.jpg
catalog: true
tags:
  - v8
---

# 简介

高级代码执行有两种方式，需要将代码编译成二进制代码给计算机执行（编译执行），另外一种方式是在计算机安装一个解释器，并由解释器来解释执行（解释执行）。

而 v8 采用的是采即时编译（JIT）的双轮驱动的设计，这是一种策略，混合编译执行和解释执行两种手段，给 js 的执行速度带来了很大的提升。解释执行的启动速度快，但是执行时的速度慢，而编译执行的启动速度慢，但是执行时的速度快。首先 v8 在启动的过程中会采用解释执行，如果识别到了某一段代码执行的频率超过了一定的值，那么 v8 会将这段代码转变成执行效率更高的编译执行。

- 解释执行：需要先将输入的源代码通过解析器编译成中间代码，之后直接使用解释器解释执行中间代码，然后直接输出结果。

  流程：代码-》解析-》中间代码-》解释器执行-》结果

- 编译执行：采用这种方式时，也需要先将源代码转换为中间代码，然后我们的编译器再将中间代码编译成机器代码

  流程：代码-》解析-》中间代码-》编译器-二进制带啊吗-》机器执行-》结果

# V8 如何执行 js

![Image text](/img/8a34ae8c1a7a0f87e19b1384a025e354.webp)

- v8 在执行的时候会首先准备基础环境，包括全局上下文、消息循环、作用域、堆和栈空间
- 然后对代码进行解析生成 AST 语法树，在这个阶段还会生成作用域
- 生成 AST 后会转变成字节吗，字节码是 AST 和机器代码之间的中间代码
- 生成字节码后会交给解释器执行，然后输出结果。
- 如果监控到解释器重复执行到了一段代码，那么会将该代码标记成热点代码，v8 会将这段代码提交给优化编译器编译成二进制代码，并且对二进制代码进行优化操作。如果这段代码下次再次执行到了，那么效率会大幅提升。
- js 是动态语言，对象的结构和属性是可以更改的，而优化编译器优化过的代码只能针对固定的结构，所以在执行的过程中如果对象的的结构被改变了，那么编译后的代码就无效了，这个时候优化编译器就会执行反优化操作，经过反优化的的代码会被会推倒解释器执行
